<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Voting API Test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {};
  </script>
</head>
<body class="bg-gray-50 p-4 sm:p-8 font-sans text-gray-800">
  <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-indigo-700">Voting API Test Page</h2>

  <div class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm bg-white">
    <h3 class="text-xl font-semibold mb-3 text-indigo-600">Authentication</h3>
    <form id="loginForm" class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
      <input name="voucher" placeholder="voucher (8 chars)" required class="p-2 border rounded-md w-full sm:w-auto" />
      <button type="submit" class="bg-indigo-500 text-white py-2 px-4 rounded-md">Login (sets httpOnly cookie)</button>
    </form>
    <button id="logoutBtn" class="bg-red-500 text-white py-2 px-4 rounded-md">Logout (clear cookie)</button>
  </div>

  <hr class="my-6"/>

  <div class="mb-6 p-4 border rounded bg-white space-y-4">
    <h3 class="text-xl text-indigo-600">Creation Endpoints</h3>

    <form id="createUserForm" class="flex gap-2">
      <input name="voucher" placeholder="new voucher" required class="p-2 border rounded-md" />
      <button type="submit" class="bg-green-500 text-white py-2 px-4 rounded-md">Create User</button>
    </form>

    <form id="createPositionForm" class="flex gap-2">
      <input name="position_name" placeholder="position name" required class="p-2 border rounded-md" />
      <button type="submit" class="bg-green-500 text-white py-2 px-4 rounded-md">Create Position</button>
    </form>

    <form id="createCandidateForm" class="flex gap-2 flex-wrap">
      <input name="positionId" placeholder="position id" required class="p-2 border rounded-md" />
      <input name="name" placeholder="candidate name" required class="p-2 border rounded-md" />
      <input name="manifesto" placeholder="manifesto (optional)" class="p-2 border rounded-md" />
      <button type="submit" class="bg-green-500 text-white py-2 px-4 rounded-md">Create Candidate</button>
    </form>

    <form id="castVoteForm" class="flex gap-2 flex-wrap">
      <input name="voucher" placeholder="voucher" required class="p-2 border rounded-md" />
      <input name="candidateId" placeholder="candidate id" required class="p-2 border rounded-md" />
      <input name="positionId" placeholder="position id" required class="p-2 border rounded-md" />
      <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-md">Cast Vote â€” verification code returned</button>
    </form>
  </div>

  <hr class="my-6"/>

  <div class="mb-6 p-4 border rounded bg-white">
    <h3 class="text-xl text-indigo-600">GET / Verify</h3>
    <div class="flex gap-2 mb-4">
      <button id="getUsersBtn" class="bg-teal-500 text-white py-2 px-4 rounded-md">GET /users (protected)</button>
      <button id="getPositionsBtn" class="bg-teal-500 text-white py-2 px-4 rounded-md">GET /positions</button>
      <button id="getCandidatesBtn" class="bg-teal-500 text-white py-2 px-4 rounded-md">GET /positions/1/candidates</button>
      <button id="authCheckBtn" class="bg-yellow-500 text-white py-2 px-4 rounded-md">POST /auth</button>
    </div>

    <form id="verifyForm" class="flex gap-2">
      <input name="verification_code" placeholder="Verification code" class="p-2 border rounded-md" />
      <button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md">Verify Vote</button>
    </form>
  </div>

  <h3 class="text-xl text-indigo-600 mt-6">Response</h3>
  <pre id="output" class="bg-gray-800 text-green-300 p-4 rounded max-h-96 overflow-auto">Ready</pre>

  <script>
    const base = location.origin + '/api/v1';
    const out = document.getElementById('output');

    function show(r) { out.textContent = JSON.stringify(r, null, 2); }

    async function doFetch(path, opts = {}) {
      opts.credentials = opts.credentials || 'include';
      opts.headers = opts.headers || {};
      if (opts.body && typeof opts.body === 'object') {
        opts.headers['Content-Type'] = 'application/json';
        opts.body = JSON.stringify(opts.body);
      }
      const res = await fetch(base + path, opts);
      const raw = await res.text();
      let parsed;
      try { parsed = JSON.parse(raw); } catch (e) { parsed = raw; }
      const headers = Object.fromEntries(res.headers);
      const outObj = { status: res.status, ok: res.ok, body: parsed, headers };
      show(outObj);
      return outObj;
    }

    // handlers
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const voucher = e.target.voucher.value.trim();
      if (!voucher) return alert('voucher required');
      await doFetch('/login', { method: 'POST', body: { voucher } });
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await doFetch('/logout', { method: 'POST' });
    });

    document.getElementById('createUserForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const voucher = e.target.voucher.value.trim();
      await doFetch('/users', { method: 'POST', body: { voucher } });
    });

    document.getElementById('createPositionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const position_name = e.target.position_name.value.trim();
      await doFetch('/positions', { method: 'POST', body: { position_name } });
    });

    document.getElementById('createCandidateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const positionId = e.target.positionId.value.trim();
      const name = e.target.name.value.trim();
      const manifesto = e.target.manifesto.value.trim();
      await doFetch(`/positions/${positionId}/candidates`, { method: 'POST', body: { name, manifesto } });
    });

    document.getElementById('castVoteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        voucher: e.target.voucher.value.trim(),
        candidateId: Number(e.target.candidateId.value),
        positionId: Number(e.target.positionId.value)
      };
      const { body } = await doFetch('/vote', { method: 'POST', body: data });
      const code = body?.data?.verification_code || body?.verification_code;
      if (code) alert('Verification code: ' + code);
    });

    document.getElementById('getUsersBtn').addEventListener('click', async () => {
      await doFetch('/users', { method: 'GET' });
    });

    document.getElementById('getPositionsBtn').addEventListener('click', async () => {
      await doFetch('/positions', { method: 'GET' });
    });

    document.getElementById('getCandidatesBtn').addEventListener('click', async () => {
      await doFetch('/positions/1/candidates', { method: 'GET' });
    });

    document.getElementById('authCheckBtn').addEventListener('click', async () => {
      const voucher = prompt('voucher to check');
      if (!voucher) return;
      await doFetch('/auth', { method: 'POST', body: { voucher } });
    });

    document.getElementById('verifyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const code = e.target.verification_code.value.trim();
      if (!code) return alert('verification_code required');
      await doFetch('/verify', { method: 'POST', body: { verification_code: code } });
    });
  </script>
</body>
</html>